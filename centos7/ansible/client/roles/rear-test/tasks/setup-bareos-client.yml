---
# ansible/client/roles/rear-test/tasks/setup-bareos-client.yml

- name: copy bareos.repo to /etc/yum.repos.d directory
  copy: src=bareos.repo dest=/etc/yum.repos.d/bareos.repo mode=0644 owner=root
  when: ansible_os_family == "RedHat"

- name: add http://download.bareos.org/bareos/release/latest/xUbuntu repo
  apt_repository:
    repo: deb http://download.bareos.org/bareos/release/latest/xUbuntu_{{ ansible_distribution_version }}/ ./
    state: present
    update_cache: yes
  when: ansible_distribution == "Ubuntu"

- name: Install bareos client packages (rh arch)
  package: name={{ item }} state=present
  with_items:
   - bareos-filedaemon
   - bareos-bconsole
  when: ansible_os_family == "RedHat"

- name: Install bareos pre-requisites for ubuntu14 only
  package: name={{ item }} state=present  allow_unauthenticated=yes
  with_items:  
   - libfastlz
   - libjansson4
   - liblzo2-2
   - bareos-common
  when: ansible_distribution == "Ubuntu" AND ansible_distribution_major_version == 14

- name: Install bareos client packages (deb arch)
  package: name={{ item }} state=present  allow_unauthenticated=yes
  with_items:
   - bareos-filedaemon
   - bareos-bconsole
  when: ansible_os_family == "Debian"


- name: copy bareos configuration files to /etc/bareos
  copy: src={{ item }} dest=/etc/bareos/{{ item }} owner=bareos group=bareos mode=0644
  with_items:
    - bareos-fd.conf
    - bconsole.conf

- name: copy the pre-backup script for rear/bareos (rear mkbackup calls this one)
  copy: src=client-backup-with-bareos dest=/etc/rear/client-backup-with-bareos owner=root mode=0755

- name: Enable/Start bareos related services
  service: name={{ item }} state=started enabled=yes
  with_items:
   - bareos-fd
